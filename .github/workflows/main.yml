name: VPS
on:
  workflow_dispatch:

jobs:
  secure-vps:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 ÿ≥ÿßÿπÿßÿ™
    steps:
      - name: Prepare environment
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server curl unzip jq
          echo "‚úÖ Environment ready"

      - name: Configure SSH
        run: |
          sudo systemctl enable ssh
          sudo systemctl start ssh
          echo "root:admin@123" | sudo chpasswd
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo service ssh restart
          echo "‚úÖ SSH configured: user=root | pass=admin@123"

      - name: Install Ngrok
        run: |
          curl -sL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -o ngrok.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/ngrok
          ngrok config add-authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          echo "‚úÖ Ngrok installed successfully"

      - name: Start Ngrok Tunnel
        run: |
          nohup ngrok tcp 22 --region eu > /dev/null 2>&1 &
          sleep 10
          # ÿ™ÿ£ŸÉÿØ ÿ£ŸÜ ngrok ÿ¥ÿ∫ŸëÿßŸÑ ŸÇÿ®ŸÑ ŸÖÿ≠ÿßŸàŸÑÿ© ÿ¨ŸÑÿ® ÿßŸÑÿ±ÿßÿ®ÿ∑
          if ! curl -s http://127.0.0.1:4040/api/tunnels > /dev/null; then
            echo "‚ùå ngrok ŸÑŸÖ Ÿäÿ®ÿØÿ£ ÿ®ÿπÿØ. ŸÅÿ¥ŸÑ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®Ÿàÿßÿ¨Ÿáÿ© API." && exit 1
          fi
          NGROK_URL=$(curl -s http://127.0.0.1:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          if [ -z "$NGROK_URL" ] || [ "$NGROK_URL" = "null" ]; then
            echo "‚ùå ŸÅÿ¥ŸÑ ŸÅŸä ÿ¨ŸÑÿ® ÿ±ÿßÿ®ÿ∑ ngrok." && exit 1
          fi
          echo "NGROK_URL=$NGROK_URL" >> $GITHUB_ENV
          echo "‚úÖ Ngrok Tunnel started: $NGROK_URL"

      - name: Show Connection Info
        run: |
          echo "------------------------------------"
          echo "‚úÖ VPS is Ready!"
          echo "üåç Connect using:"
          echo "ssh root@${NGROK_URL#tcp://}"
          echo "üîë Password: admin@123"
          echo "------------------------------------"

      - name: Keep VPS Alive
        run: |
          while true; do
            echo "[$(date)] VPS running..."
            sleep 300
          done
